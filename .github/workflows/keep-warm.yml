name: Keep Supabase Warm

on:
  schedule:
    # 15分おき（無料枠向けの控えめな間隔）
    - cron: '*/15 * * * *'
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  ping-health-endpoint:
    runs-on: ubuntu-latest
    steps:
      - name: Call health endpoint
        env:
          HEALTHCHECK_URL: ${{ secrets.HEALTHCHECK_URL }}
        run: |
          if [ -z "$HEALTHCHECK_URL" ]; then
            echo "HEALTHCHECK_URL secret is not set. Add it in the repo settings."
            exit 1
          fi

          # Retry up to 3 times in case the pool is still waking up.
          for i in 1 2 3; do
            if curl -fsS --max-time 10 "$HEALTHCHECK_URL"; then
              echo "Health check succeeded on attempt $i"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 5
          done

          echo "Health check failed after 3 attempts"
          exit 1
